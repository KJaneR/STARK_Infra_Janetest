AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: WIP template for the STARK infra CI/CD pipeline. Will be merged with template.yml and CFWriter when complete, then deleted. 
Resources:
    STARKCodeBuildServiceRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement: 
                    - 
                        Effect: Allow
                        Principal:
                           Service: 
                              - codebuild.amazonaws.com"
                        Action: "sts:AssumeRole"
            Policies:
                - PolicyName: PolicyForSTARKCodeBuildServiceRole
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                        - 
                            Effect: Allow
                            Action:
                                - 'logs:CreateLogGroup'
                                - 'logs:CreateLogStream'
                                - 'logs:PutLogEvents'
                                - 's3:PutObject'
                                - 's3:GetObject'
                                - 's3:GetObjectVersion'
                                - 's3:GetBucketAcl'
                                - 's3:GetBucketLocation'
                                - 'codebuild:CreateReportGroup'
                                - 'codebuild:CreateReport'
                                - 'codebuild:UpdateReport'
                                - 'codebuild:BatchPutTestCases'
                            Resource: '*'
    STARKRepo:
        Type: AWS::CodeCommit::Repository
        Properties:
            RepositoryName: STARK_v1_contributor
            RepositoryDescription: Default Git repo for the STARK tool, for contributors
    STARKBuildProject:
        Type: AWS::CodeBuild::Project
        Properties:
            Name: STARK_v1_contributor_build
            Artifacts:
                Type: CODEPIPELINE  
            Description: Default Build Project for the STARK CI/CD Pipeline
            Environment:
                ComputeType: BUILD_GENERAL1_SMALL
                Image: "aws/codebuild/standard:4.0"
                Type: LINUX_CONTAINER
            ServiceRole: !GetAtt STARKCodeBuildServiceRole.Arn
            Source:
                Type: CODEPIPELINE
    STARKCICDPipeline:
        Type: AWS::CodePipeline::Pipeline
        Properties:
            Name: STARK_v1_contributor_pipeline
            ArtifactStore: 
                Type: S3
                Location: waynestark-pipeline-0
            RoleArn: arn:aws:iam::201649379729:role/service-role/AWSCodePipelineServiceRole-ap-southeast-1-STARK-lambda-pipeline
            Stages:
                -
                    Name: Source
                    Actions:
                        -
                            Name: SourceAction
                            RunOrder: 1
                            ActionTypeId:
                                Category: Source
                                Owner: AWS
                                Provider: CodeCommit
                                Version: '1'
                            Configuration:
                                RepositoryName: !GetAtt STARKRepo.Name
                                PollForSourceChanges: 'true'
                                BranchName: master
                            InputArtifacts: []
                            OutputArtifacts:
                                - Name: SourceArtifact
                -
                    Name: Build
                    Actions:
                        -
                            Name: BuildAction
                            RunOrder: 2
                            ActionTypeId:
                                Category: Build
                                Owner: AWS
                                Provider: CodeBuild
                                Version: '1'
                            Configuration:
                                ProjectName: !Ref STARKBuildProject
                            InputArtifacts:
                                - Name: SourceArtifact
                            OutputArtifacts:
                                - Name: BuildArtifact
                -
                    Name: Deploy
                    Actions:
                        -
                            Name: ChangeSetReplace
                            RunOrder: 3
                            ActionTypeId:
                                Category: Deploy
                                Owner: AWS
                                Provider: CloudFormation
                                Version: '1'
                            Configuration:
                                ActionMode: CHANGE_SET_REPLACE
                                StackName: STARK-v1-contributor
                                Capabilities: CAPABILITY_IAM, CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                                ChangeSetName: STARK-v1-contributor-changeset
                                TemplatePath: "BuildArtifact::outputtemplate.yml"
                                TemplateConfiguration: "BuildArtifact::template_configuration.json"
                                RoleArn: "arn:aws:iam::201649379729:role/cfn-lambda-pipeline"
                            InputArtifacts:
                                - Name: BuildArtifact
                            OutputArtifacts: []
                        -
                            Name: ExecuteChangeSet
                            RunOrder: 4
                            ActionTypeId:
                                Category: Deploy
                                Owner: AWS
                                Provider: CloudFormation
                                Version: '1'
                            Configuration:
                                ActionMode: CHANGE_SET_EXECUTE
                                StackName: STARK-v1-contributor
                                Capabilities: CAPABILITY_IAM, CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                                ChangeSetName: STARK-v1-contributor-changeset
                            InputArtifacts:
                                - Name: BuildArtifact
                            OutputArtifacts: []
                